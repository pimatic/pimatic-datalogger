<!DOCTYPE html><html lang="en"><head><title>datalogger</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="datalogger"><meta name="groc-project-path" content="datalogger.coffee"><meta name="groc-github-url" content="https://github.com/sweetpi/pimatic"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><link rel="stylesheet" type="text/css" media="all" href="assets/customStyle.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/sweetpi/pimatic/blob/master/datalogger.coffee">datalogger.coffee</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="nv">module.exports = </span><span class="nf">(env) -&gt;</span>

  <span class="nv">convict = </span><span class="nx">env</span><span class="p">.</span><span class="nx">require</span> <span class="s">&quot;convict&quot;</span>
  <span class="nv">Q = </span><span class="nx">env</span><span class="p">.</span><span class="nx">require</span> <span class="s">&#39;q&#39;</span>
  <span class="nv">assert = </span><span class="nx">env</span><span class="p">.</span><span class="nx">require</span> <span class="s">&#39;cassert&#39;</span>
  <span class="nv">_ = </span><span class="nx">env</span><span class="p">.</span><span class="nx">require</span> <span class="s">&#39;lodash&#39;</span>
  <span class="nv">fs = </span><span class="nx">env</span><span class="p">.</span><span class="nx">require</span> <span class="s">&#39;fs.extra&#39;</span>

  <span class="nv">path = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>

  <span class="k">class</span> <span class="nx">DataLoggerPlugin</span> <span class="k">extends</span> <span class="nx">env</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">Plugin</span>

    <span class="nv">deviceListener: </span><span class="p">{}</span>

    <span class="nv">init: </span><span class="nf">(@app, @framework, @config) =&gt;</span>
      <span class="nv">conf = </span><span class="nx">convict</span> <span class="nx">require</span><span class="p">(</span><span class="s">&quot;./datalogger-config-shema&quot;</span><span class="p">)</span>
      <span class="nx">conf</span><span class="p">.</span><span class="nx">load</span> <span class="nx">config</span> 
      <span class="nx">conf</span><span class="p">.</span><span class="nx">validate</span><span class="p">()</span>

      <span class="k">unless</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">devices</span><span class="o">?</span> <span class="k">then</span> <span class="vi">@config.devices = </span><span class="p">[]</span>

      <span class="nx">@framework</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;device&quot;</span><span class="p">,</span> <span class="nf">(device) =&gt;</span>
        <span class="nv">c = </span> <span class="nx">@getDeviceConfig</span> <span class="nx">device</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span> <span class="nx">c</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@addLoggerForDevice</span> <span class="nx">device</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">attributes</span>
        <span class="k">return</span>

      <span class="nx">@framework</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;after init&quot;</span><span class="p">,</span> <span class="o">=&gt;</span>
        
        <span class="nv">mobileFrontend = </span><span class="nx">@framework</span><span class="p">.</span><span class="nx">getPlugin</span> <span class="s">&#39;mobile-frontend&#39;</span>
        <span class="k">if</span> <span class="nx">mobileFrontend</span><span class="o">?</span>
          <span class="nx">mobileFrontend</span><span class="p">.</span><span class="nx">registerAssetFile</span> <span class="s">&#39;js&#39;</span><span class="p">,</span> <span class="s">&quot;pimatic-datalogger/app/js/highstock.js&quot;</span>
          <span class="nx">mobileFrontend</span><span class="p">.</span><span class="nx">registerAssetFile</span> <span class="s">&#39;js&#39;</span><span class="p">,</span> <span class="s">&quot;pimatic-datalogger/app/datalogger-page.coffee&quot;</span>
          <span class="nx">mobileFrontend</span><span class="p">.</span><span class="nx">registerAssetFile</span> <span class="s">&#39;css&#39;</span><span class="p">,</span> <span class="s">&quot;pimatic-datalogger/app/css/datalogger.css&quot;</span>
          <span class="nx">mobileFrontend</span><span class="p">.</span><span class="nx">registerAssetFile</span> <span class="s">&#39;html&#39;</span><span class="p">,</span> <span class="s">&quot;pimatic-datalogger/app/datalogger-page.jade&quot;</span>
        <span class="k">else</span>
          <span class="nx">env</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;datalogger could not find mobile-frontend. No gui will be available&quot;</span>

        <span class="k">for</span> <span class="nx">sensor</span> <span class="k">in</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">devices</span> 
          <span class="k">unless</span> <span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">sensor</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span>
            <span class="nx">env</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;No device with id: </span><span class="si">#{</span><span class="nx">sensor</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s"> found to log values.&quot;</span>
        <span class="k">return</span>

      <span class="nv">sendError = </span><span class="nf">(res, error) =&gt;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="mi">406</span><span class="p">,</span> <span class="nv">success: </span><span class="kc">false</span><span class="p">,</span> <span class="nv">message: </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span>

      <span class="nv">sendSuccess = </span><span class="nf">(res, message) =&gt;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nv">success: </span><span class="kc">true</span><span class="p">,</span> <span class="nv">message: </span><span class="nx">message</span>

      <span class="nv">getDeviceFromRequest = </span><span class="nf">(req) =&gt;</span>
        <span class="nv">deviceId = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">deviceId</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">deviceId</span><span class="o">?</span> <span class="o">or</span> <span class="nx">deviceId</span> <span class="o">is</span> <span class="s">&quot;undefined&quot;</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;No deviceId given&quot;</span> 
        <span class="nv">device = </span><span class="nx">@framework</span><span class="p">.</span><span class="nx">getDeviceById</span> <span class="nx">deviceId</span>
        <span class="k">unless</span> <span class="nx">device</span><span class="o">?</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Could not find device.&quot;</span>
        <span class="k">return</span> <span class="nx">device</span>

      <span class="nv">getAttributeFromRequest = </span><span class="nf">(req, device) =&gt;</span>
        <span class="nv">attribute = </span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">attribute</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">attribute</span><span class="o">?</span> <span class="o">or</span> <span class="nx">attribute</span> <span class="o">is</span> <span class="s">&quot;undefined&quot;</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;No attribute name given.&quot;</span> 
        <span class="k">unless</span> <span class="nx">device</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="nx">attribute</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Illegal value for this device.&quot;</span>
        <span class="k">return</span> <span class="nx">attribute</span>

      <span class="nx">@app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/datalogger/info/:deviceId&#39;</span><span class="p">,</span> <span class="nf">(req, res, next) =&gt;</span>
        <span class="k">try</span>
          <span class="nv">device = </span><span class="nx">getDeviceFromRequest</span> <span class="nx">req</span>
        <span class="k">catch</span> <span class="nx">e</span>
          <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">e</span>

        <span class="nv">c = </span><span class="nx">@getDeviceConfig</span> <span class="nx">device</span><span class="p">.</span><span class="nx">id</span>
        <span class="nv">loggedAttributes = </span><span class="p">(</span><span class="k">if</span> <span class="nx">c</span><span class="o">?</span> <span class="k">then</span> <span class="nx">c</span><span class="p">.</span><span class="nx">attributes</span> <span class="k">else</span> <span class="p">[])</span>

        <span class="nv">info =</span>
         <span class="nv">loggingAttributes: </span><span class="p">{}</span>

        <span class="k">for</span> <span class="nx">attribute</span> <span class="k">of</span> <span class="nx">device</span><span class="p">.</span><span class="nx">attributes</span>
          <span class="nx">info</span><span class="p">.</span><span class="nx">loggingAttributes</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">attribute</span> <span class="k">in</span> <span class="nx">loggedAttributes</span><span class="p">)</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">info</span>

      <span class="nx">@app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/datalogger/add/:deviceId/:attribute&#39;</span><span class="p">,</span> <span class="nf">(req, res, next) =&gt;</span>
        <span class="k">try</span>
          <span class="nv">device = </span><span class="nx">getDeviceFromRequest</span> <span class="nx">req</span>
          <span class="nv">attribute = </span><span class="nx">getAttributeFromRequest</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">device</span>
        <span class="k">catch</span> <span class="nx">e</span>
          <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">e</span>

        <span class="nx">@addDeviceToConfig</span> <span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">[</span><span class="nx">attribute</span><span class="p">]</span>
        <span class="nx">@addLoggerForDevice</span> <span class="nx">device</span><span class="p">,</span> <span class="p">[</span><span class="nx">attribute</span><span class="p">]</span>
        <span class="nx">sendSuccess</span> <span class="nx">res</span><span class="p">,</span> <span class="s">&quot;Added logging for </span><span class="si">#{</span><span class="nx">attribute</span><span class="si">}</span><span class="s">.&quot;</span>

      <span class="nx">@app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/datalogger/remove/:deviceId/:attribute&#39;</span><span class="p">,</span> <span class="nf">(req, res, next) =&gt;</span>
        <span class="k">try</span>
          <span class="nv">device = </span><span class="nx">getDeviceFromRequest</span> <span class="nx">req</span>
          <span class="nv">attribute = </span><span class="nx">getAttributeFromRequest</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">device</span>
        <span class="k">catch</span> <span class="nx">e</span>
          <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">e</span>

        <span class="nx">@removeDeviceFromConfig</span> <span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">[</span><span class="nx">attribute</span><span class="p">]</span>
        <span class="nx">@removeLoggerForDevice</span> <span class="nx">device</span><span class="p">,</span> <span class="p">[</span><span class="nx">attribute</span><span class="p">]</span>
        <span class="nx">sendSuccess</span> <span class="nx">res</span><span class="p">,</span> <span class="s">&quot;Removed logging for </span><span class="si">#{</span><span class="nx">attribute</span><span class="si">}</span><span class="s">.&quot;</span>

      <span class="nx">@app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/datalogger/data/:deviceId/:attribute&#39;</span><span class="p">,</span> <span class="nf">(req, res, next) =&gt;</span>
        <span class="k">try</span>
          <span class="nv">device = </span><span class="nx">getDeviceFromRequest</span> <span class="nx">req</span>
          <span class="nv">attribute = </span><span class="nx">getAttributeFromRequest</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">device</span>
        <span class="k">catch</span> <span class="nx">e</span>
          <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">e</span>

        <span class="nx">@getData</span><span class="p">(</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(data) =&gt;</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nv">data: </span><span class="nx">data</span>
        <span class="p">).</span><span class="nx">done</span><span class="p">()</span>

      <span class="nx">@app</span><span class="p">.</span><span class="nx">post</span> <span class="s">&#39;/datalogger/data/:deviceId/:attribute&#39;</span><span class="p">,</span> <span class="nf">(req, res, next) =&gt;</span>
        <span class="k">try</span>
          <span class="nv">device = </span><span class="nx">getDeviceFromRequest</span> <span class="nx">req</span>
          <span class="nv">attribute = </span><span class="nx">getAttributeFromRequest</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">device</span>
          <span class="nv">fromTime = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">fromTime</span>
          <span class="nv">toTime = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">toTime</span>
          <span class="k">unless</span> <span class="nx">fromTime</span><span class="o">?</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;fromTime not given&quot;</span>
          <span class="k">unless</span> <span class="nx">toTime</span><span class="o">?</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;toTime not given&quot;</span>
          <span class="nv">from = </span><span class="k">new</span> <span class="nb">Date</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">fromTime</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
          <span class="nv">to = </span><span class="k">new</span> <span class="nb">Date</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">toTime</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">catch</span> <span class="nx">e</span>
          <span class="k">return</span> <span class="nx">sendError</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">e</span>

        <span class="nx">@getDataInRange</span><span class="p">(</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(data) =&gt;</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nv">data: </span><span class="nx">data</span>
        <span class="p">).</span><span class="nx">done</span><span class="p">()</span>

    <span class="nv">logData: </span><span class="p">(</span><span class="nx">deviceId</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">())</span> <span class="nf">-&gt;</span>
      <span class="nx">assert</span> <span class="nx">deviceId</span><span class="o">?</span>
      <span class="nx">assert</span> <span class="nx">attribute</span><span class="o">?</span>
      <span class="nx">assert</span> <span class="nx">value</span><span class="o">?</span>

      <span class="nv">file = </span><span class="nx">@getPathOfLogFile</span> <span class="nx">deviceId</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">date</span>
      <span class="nv">defer = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">exists</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">)</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(exists) =&gt;</span>
        <span class="k">unless</span> <span class="nx">exists</span>
          <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirs</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
      <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="o">=&gt;</span>
        <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">appendFile</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span><span class="si">}</span><span class="s">,</span><span class="si">#{</span><span class="nx">value</span><span class="si">}</span><span class="s">\n&quot;</span>
      <span class="p">)</span>

    <span class="nv">getDataInRange: </span><span class="nf">(deviceId, attribute, from, to) -&gt;</span>
      <span class="k">if</span> <span class="nx">from</span> <span class="o">&gt;</span> <span class="nx">to</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">Q</span> <span class="p">[]</span>

      <span class="nv">fromTime = </span><span class="nx">from</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>
      <span class="nv">toTime = </span><span class="nx">to</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span>

      <span class="c1">#console.log from, &quot;form&quot;</span>
      <span class="c1">#console.log to, &quot;to&quot;</span>
      <span class="nv">data = </span><span class="p">[]</span>
      
      <span class="nx">@walkYears</span><span class="p">(</span><span class="nx">deviceId</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nf">(year) =&gt;</span>
        <span class="nv">currentTo = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span><span class="p">)</span> <span class="c1">#last Day of year</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the current year is before the requested range start then
we can skip the year</p></div></div><div class="code"><div class="wrapper">        <span class="k">unless</span> <span class="nx">currentTo</span> <span class="o">&lt;</span> <span class="nx">from</span> 
          <span class="nx">@walkMonths</span><span class="p">(</span><span class="nx">deviceId</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">year</span><span class="p">,</span> <span class="nf">(month) =&gt;</span>
            <span class="nx">currentTo</span><span class="p">.</span><span class="nx">setMonth</span><span class="p">(</span><span class="nx">month</span><span class="p">)</span>
            <span class="nx">currentTo</span><span class="p">.</span><span class="nx">setDate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="nx">currentTo</span><span class="p">.</span><span class="nx">setMonth</span><span class="p">(</span><span class="nx">currentTo</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the current month is before the requested range then
we can skip the month </p></div></div><div class="code"><div class="wrapper">            <span class="k">unless</span> <span class="nx">currentTo</span> <span class="o">&lt;</span> <span class="nx">from</span> 
              <span class="nx">@walkDays</span><span class="p">(</span><span class="nx">deviceId</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="p">,</span> <span class="nf">(day) =&gt;</span>
                <span class="nx">currentTo</span><span class="p">.</span><span class="nx">setDate</span> <span class="nx">day</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the day is before the requested range  then
we can skip the day</p></div></div><div class="code"><div class="wrapper">                <span class="k">unless</span> <span class="nx">currentTo</span> <span class="o">&lt;</span> <span class="nx">from</span> 
                  <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span> <span class="nx">month</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">day</span><span class="p">)</span>
                  <span class="nv">file = </span><span class="nx">@getPathOfLogFile</span> <span class="nx">deviceId</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">date</span>
                  <span class="c1">#console.log &quot;reading file&quot;, file</span>
                  <span class="nx">@readDataFromFile</span><span class="p">(</span><span class="nx">file</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(d) =&gt;</span>
                    <span class="nv">data = </span><span class="nx">data</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nf">([time,]) =&gt;</span> <span class="nx">fromTime</span> <span class="o">&lt;=</span> <span class="nx">time</span> <span class="o">&lt;=</span> <span class="nx">toTime</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just continue if the end of the current day is before the end
of the requested range</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">currentTo</span> <span class="o">&lt;</span> <span class="nx">to</span>
                  <span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just continue if the end of the current day is before the end
of the requested rannge</p></div></div><div class="code"><div class="wrapper">                <span class="k">else</span> <span class="nx">currentTo</span> <span class="o">&lt;</span> <span class="nx">to</span>
              <span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just continue if the end of the current month is before the end
of the requested rannge</p></div></div><div class="code"><div class="wrapper">            <span class="k">else</span> <span class="nx">currentTo</span> <span class="o">&lt;</span> <span class="nx">to</span>
          <span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Just continue if the end of the current year is before the end
of the requested rannge</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span> <span class="nx">currentTo</span> <span class="o">&lt;</span> <span class="nx">to</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Finally return the concatinated data.</p></div></div><div class="code"><div class="wrapper">      <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="o">=&gt;</span> <span class="nx">data</span> <span class="p">)</span>


    <span class="nv">fileToNum : </span><span class="nf">(file) =&gt;</span>  <span class="nb">parseInt</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="s">&#39;.csv&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
    <span class="nv">dirToNum: </span><span class="nf">(dir) =&gt;</span>  <span class="nb">parseInt</span> <span class="nx">dir</span><span class="p">,</span> <span class="mi">10</span>
    <span class="nv">pad: </span><span class="nf">(n) =&gt;</span> <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">then</span> <span class="s">&#39;0&#39;</span><span class="o">+</span><span class="nx">n</span> <span class="k">else</span> <span class="nx">n</span>

    <span class="nv">walkYears: </span><span class="nf">(deviceId, attribute, callback) =&gt;</span>
      <span class="nv">dir = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">maindir</span><span class="p">,</span> 
        <span class="s">&quot;../../datalogger/</span><span class="si">#{</span><span class="nx">deviceId</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">attribute</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">,</span> <span class="nx">dir</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(dirs) =&gt;</span>
        <span class="nv">years = </span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">dirs</span><span class="p">,</span> <span class="nx">@dirToNum</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span>
        <span class="nv">chain = </span><span class="nx">Q</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">year</span> <span class="k">in</span> <span class="nx">years</span>
          <span class="nx">do</span> <span class="nf">(year) =&gt;</span>
            <span class="nv">chain = </span><span class="nx">chain</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(cont) =&gt;</span>
              <span class="k">if</span> <span class="nx">cont</span> <span class="k">then</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">year</span><span class="p">)</span> <span class="k">else</span> <span class="kc">false</span> 
            <span class="p">)</span>
        <span class="k">return</span> <span class="nx">chain</span>
      <span class="p">)</span>

    <span class="nv">walkMonths: </span><span class="nf">(deviceId, attribute, year, callback) =&gt;</span>
      <span class="nv">dir = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">maindir</span><span class="p">,</span> 
        <span class="s">&quot;../../datalogger/</span><span class="si">#{</span><span class="nx">deviceId</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">attribute</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">@pad</span> <span class="nx">year</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">,</span> <span class="nx">dir</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(dirs) =&gt;</span>
        <span class="nv">months = </span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">dirs</span><span class="p">,</span> <span class="nx">@dirToNum</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span>
        <span class="nv">chain = </span><span class="nx">Q</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">month</span> <span class="k">in</span> <span class="nx">months</span>
          <span class="nx">do</span> <span class="nf">(month) =&gt;</span>
            <span class="nv">chain = </span><span class="nx">chain</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(cont) =&gt;</span>
              <span class="k">if</span> <span class="nx">cont</span> <span class="k">then</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">month</span><span class="p">)</span>
              <span class="k">else</span> <span class="kc">false</span> 
            <span class="p">)</span>
        <span class="k">return</span> <span class="nx">chain</span>
      <span class="p">)</span>

    <span class="nv">walkDays: </span><span class="nf">(deviceId, attribute, year, month, callback) =&gt;</span>
      <span class="nv">dir = </span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">maindir</span><span class="p">,</span> 
        <span class="s">&quot;../../datalogger/</span><span class="si">#{</span><span class="nx">deviceId</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">attribute</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">@pad</span> <span class="nx">year</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">@pad</span> <span class="nx">month</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">,</span> <span class="nx">dir</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(files) =&gt;</span>
        <span class="nv">days = </span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">files</span><span class="p">,</span> <span class="nx">@fileToNum</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span>
        <span class="nv">chain = </span><span class="nx">Q</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">day</span> <span class="k">in</span> <span class="nx">days</span> 
          <span class="nx">do</span> <span class="nf">(day) =&gt;</span>
            <span class="nv">chain = </span><span class="nx">chain</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(cont) =&gt;</span>
              <span class="k">if</span> <span class="nx">cont</span> <span class="k">then</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">day</span><span class="p">)</span>
              <span class="k">else</span> <span class="kc">false</span> 
            <span class="p">)</span>
        <span class="k">return</span> <span class="nx">chain</span>
      <span class="p">)</span>      

    <span class="nv">getData: </span><span class="p">(</span><span class="nx">deviceId</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nv">date = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">())</span> <span class="nf">-&gt;</span>
      <span class="nv">file = </span><span class="nx">@getPathOfLogFile</span> <span class="nx">deviceId</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">date</span>
      <span class="nv">defer = </span><span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">exists</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">)</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(exists) =&gt;</span>
        <span class="k">unless</span> <span class="nx">exists</span> <span class="k">then</span> <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span> <span class="nx">@readDataFromFile</span> <span class="nx">file</span>
      <span class="p">)</span>

    <span class="nv">readDataFromFile: </span><span class="nf">(file) -&gt;</span>
      <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">,</span> <span class="nx">file</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nf">(csv) =&gt;</span>
        <span class="nv">csv = </span><span class="nx">csv</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">csv</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="p">[]</span>
        <span class="nv">json = </span><span class="s">&#39;[[&#39;</span> <span class="o">+</span> 
          <span class="nx">csv</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n|\n|\r/gm</span><span class="p">,</span> <span class="s">&#39;],[&#39;</span><span class="p">)</span> <span class="c1">#replace new lines with `],[`</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/,\[\]/g</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="c1"># remove empty arrays: `[]`</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\],\[$/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="c1"># remove last `],[`</span>
          <span class="s">&#39;]]&#39;</span>
        <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
      <span class="p">)</span>

    <span class="nv">getPathOfLogFile: </span><span class="nf">(deviceId, attribute, date) -&gt;</span>
      <span class="nx">assert</span> <span class="nx">deviceId</span><span class="o">?</span>
      <span class="nx">assert</span> <span class="nx">attribute</span><span class="o">?</span>
      <span class="nx">assert</span> <span class="nx">date</span> <span class="k">instanceof</span> <span class="nb">Date</span>
      <span class="nv">year = </span><span class="nx">@pad</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span>
      <span class="nv">month = </span><span class="nx">@pad</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
      <span class="nv">day = </span><span class="nx">@pad</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">maindir</span><span class="p">,</span> 
        <span class="s">&quot;../../datalogger/</span><span class="si">#{</span><span class="nx">deviceId</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">attribute</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">year</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">month</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">day</span><span class="si">}</span><span class="s">.csv&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="addloggerfordevice">addLoggerForDevice()</h2>

<p>Add a sensor value listener for the given device and attributes</p></div></div><div class="code"><div class="wrapper">    <span class="nv">addLoggerForDevice: </span><span class="nf">(device, attributes) -&gt;</span>
      <span class="nx">assert</span> <span class="nx">device</span><span class="o">?</span> <span class="o">and</span> <span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="o">?</span>
      <span class="nx">assert</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">attributes</span>

      <span class="k">for</span> <span class="nx">attribute</span> <span class="k">in</span> <span class="nx">attributes</span>
        <span class="nx">do</span> <span class="nf">(attribute) =&gt;</span>
          <span class="nv">listener = </span><span class="nf">(value) =&gt;</span> <span class="nx">@logData</span><span class="p">(</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">value</span><span class="p">).</span><span class="nx">done</span><span class="p">()</span>
          <span class="k">unless</span> <span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span>
            <span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span>
              <span class="nv">listener: </span><span class="p">{}</span>
          <span class="k">unless</span> <span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">listener</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span><span class="o">?</span>
            <span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">listener</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="nx">listener</span>  
            <span class="nx">device</span><span class="p">.</span><span class="nx">on</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">listener</span>
      <span class="k">return</span>

    <span class="nv">removeLoggerForDevice: </span><span class="nf">(device, attributes) -&gt;</span>
      <span class="k">if</span> <span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">attribute</span> <span class="k">in</span> <span class="nx">attributes</span>
          <span class="nx">do</span> <span class="nf">(attribute) =&gt;</span>
            <span class="nv">listener = </span><span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">listener</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span>
            <span class="nx">device</span><span class="p">.</span><span class="nx">removeListener</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">listener</span>
            <span class="k">delete</span> <span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">listener</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">of</span> <span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">listener</span><span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="k">delete</span> <span class="nx">@deviceListener</span><span class="p">[</span><span class="nx">device</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
      <span class="k">return</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="getdeviceconfig">getDeviceConfig()</h2>

<p>Get the config entry for the given if</p></div></div><div class="code"><div class="wrapper">    <span class="nv">getDeviceConfig: </span><span class="nf">(deviceId) -&gt;</span>
      <span class="nx">assert</span> <span class="nx">deviceId</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">_</span><span class="p">(</span><span class="nx">@config</span><span class="p">.</span><span class="nx">devices</span><span class="p">).</span><span class="nx">find</span> <span class="nf">(s) =&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">deviceId</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="adddevicetoconfig">addDeviceToConfig()</h2>

<p>Add the given device id with the fiven sensor values to the config.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">addDeviceToConfig: </span><span class="nf">(deviceId, attributes) -&gt;</span>
      <span class="nx">assert</span> <span class="nx">deviceId</span><span class="o">?</span>
      <span class="nx">assert</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">attributes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the config entry for the given id.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">entry = </span><span class="nx">@getDeviceConfig</span> <span class="nx">deviceId</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the entry does not exist</p></div></div><div class="code"><div class="wrapper">      <span class="k">unless</span> <span class="nx">entry</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then create it.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">@config</span><span class="p">.</span><span class="nx">devices</span><span class="p">.</span><span class="nx">push</span>
          <span class="nv">id: </span><span class="nx">deviceId</span>
          <span class="nv">attributes: </span><span class="nx">attributes</span>
      <span class="k">else</span> </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Else just add the sensor values.</p></div></div><div class="code"><div class="wrapper">        <span class="nv">entry.attributes = </span><span class="nx">_</span><span class="p">.</span><span class="nx">union</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">attributes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save the config and return.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@framework</span><span class="p">.</span><span class="nx">saveConfig</span><span class="p">()</span>
      <span class="k">return</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="removedevicefromconfig">removeDeviceFromConfig()</h2>

<p>Removes the given sensor values from the sensor config entry with the id of deviceId</p></div></div><div class="code"><div class="wrapper">    <span class="nv">removeDeviceFromConfig: </span><span class="nf">(deviceId, attributesToRemove) -&gt;</span>
      <span class="nx">assert</span> <span class="nx">deviceId</span><span class="o">?</span>
      <span class="nx">assert</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">attributesToRemove</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get the sensor config entry.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">entry = </span><span class="nx">@getDeviceConfig</span> <span class="nx">deviceId</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If an entry was found</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">entry</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then remove the given sensor values.</p></div></div><div class="code"><div class="wrapper">        <span class="nv">entry.attributes = </span><span class="nx">_</span><span class="p">.</span><span class="nx">difference</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">attributesToRemove</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the entry has no sensor values anymore</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>then remove the entry completly from the config.</p></div></div><div class="code"><div class="wrapper">          <span class="vi">@config.devices = </span><span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">devices</span><span class="p">,</span> <span class="nf">(s) =&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span> <span class="o">isnt</span> <span class="nx">deviceId</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Save the config and return.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@framework</span><span class="p">.</span><span class="nx">saveConfig</span><span class="p">()</span>
      <span class="k">return</span>

  <span class="k">return</span> <span class="k">new</span> <span class="nx">DataLoggerPlugin</span></div></div></div></div></body></html>